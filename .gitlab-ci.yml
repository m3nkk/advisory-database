stages:
  - test
  - bump
  - deploy

missing_uuids:
  image: golang:1.11
  script:
    - go run missing_uuids/main.go .

test:
  image: ruby:2.6-alpine3.10
  before_script:
    - apk add git openssh-client
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - echo "$SEMVER_DIALECT_SSH" | tr -d '\r' | ssh-add -
  script:
    - bundle install --gemfile schema/Gemfile
    - bundle install --gemfile identifier/Gemfile
    - bundle exec --gemfile schema/Gemfile schema/validate.rb --semantic gem go npm maven packagist pypi
    - identifier/identifier.rb -v .

bump:
  image: registry.gitlab.com/gitlab-org/secure/vulnerability-research/workflow-tools/bumper:master-v1.0.0
  stage: bump
  variables:
    GIT_STRATEGY: none
  before_script:
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$BUMPER_SSH")
    - git clone git@gitlab.com:gitlab-org/security-products/gemnasium-db.git
  script: 
    - bump.rb -v "v" -c "CHANGELOG.md" -g "gemnasium-db" -n "bumper" -e "bumper@gitlab.com"
  resource_group: gemnasium-db
  only:
      refs:
        - master
  except:
      - tags

pages:
  image: julianthome/stat
  stage: deploy
  script:
    - cd stats && make
  artifacts:
    paths:
      - data/data.tar.gz
      - data/nvd.tar.gz
      - public
  allow_failure: true
  only:
    - master
