#!/usr/bin/env ruby
# frozen_string_literal: true

require 'yaml'
require 'time'
require 'json-schema'

current_dir = File.dirname(__FILE__)
schema_file = File.join(current_dir, 'schema.json')
$schema = JSON.parse(File.read(schema_file))

def validation_errors(yaml_file)
  JSON::Validator.fully_validate($schema, YAML.load_file(yaml_file).to_json)
end

Dir.glob("#{current_dir}/../**/*.yml").each do |yaml_file|
  next if %w[unknown].include?(File.basename(yaml_file, '.yml'))

  errors = validation_errors(yaml_file)
  if errors.any?
    puts "#{yaml_file} is invalid: #{errors.join('; ')}"
    exit(1)
  end
end

puts 'All yaml files are valid'
exit(0)
