#install.packages("rmarkdown")
#install.packages("ggplot2")

package_type_distro <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  package_type = unique(mydata$packagetype)
  advisories <- c()
  for(x in package_type){
    #d <- mydata[ which(mydata$package.type==x & grepl('CVE', mydata$file)), ]
    d <- mydata[ which(mydata$packagetype==x), ]
    advisories <- c(advisories, nrow(d))
  }
  pct <- round(advisories/sum(advisories)*100)
  package_type <- paste(package_type,"#")
  package_type <- paste(package_type, advisories)
  package_type <- paste(package_type,"(",pct)
  package_type <- paste(package_type,"%",sep="")
  package_type <- paste(package_type,")")
  pie(advisories, labels = package_type, main=paste("Advisory Distribution (Package Type) Total:", sum(advisories)))
}

cve_distro <- function(csv) {
  advisory_type <- c("CVEs", "Non CVEs")
  advisories <- c()
  mydata = read.table(csv, header = TRUE,  sep = ",")
  
  # CVEs
  cves <- mydata[ which(grepl('CVE', mydata$file)), ]
  advisories <- c(advisories, nrow(cves))
  
  # Non CVEs
  ncves <- mydata[ which(!grepl('CVE', mydata$file)), ]
  advisories <- c(advisories, nrow(ncves))
  
  pct <- round(advisories/sum(advisories)*100)
  advisory_type <- paste(advisory_type,"#")
  advisory_type <- paste(advisory_type, advisories)
  advisory_type <- paste(advisory_type,"(",pct)
  advisory_type <- paste(advisory_type,"%",sep="")
  advisory_type <- paste(advisory_type,")")
  pie(advisories, labels = advisory_type,  main=paste("Advisory Distribution (CVEs) Total:", sum(advisories)))
}

mean_time_to_merge <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  delta_data <- mydata[ which(mydata$delta>=0 & grepl('CVE', mydata$file)), ]
  mean(delta_data$delta)
}

median_time_to_merge <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  delta_data <- mydata[ which(mydata$delta>=0 & grepl('CVE', mydata$file)), ]
  median(delta_data$delta)
}

merged_advisories <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  cve_data <- mydata[ which(grepl('CVE', mydata$file)), ]
  creation_date = c(cve_data$mergedate)
  x <- as.POSIXct(cve_data$mergedate)
  mo <- strftime(x, "%m")
  yr <- strftime(x, "%Y")
  dd <- data.frame(mo, yr, amt = 1)
  agg <- aggregate(amt ~ mo + yr, dd, FUN = sum)
  agg$date = paste(agg$yr, agg$mo, sep = "-")
  xx <- barplot(agg$amt, 
          col = terrain.colors(6), 
          xlab="", 
          ylab="#CVE Advisories added", 
          ylim = c(0,max(agg$amt)*1.1),
          args.legend = list(bty = 'n', x = 'top', ncol = 1))
  text(x = xx, y = agg$amt, label = agg$amt, pos = 3, cex = 0.8, col = "red")
  axis(1, at=xx, labels=agg$date, tick=FALSE, las=2, line=-0.5)
}

throughput <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  cve_data <- mydata[ which(grepl('CVE', mydata$file)), ]
  x <- as.POSIXct(cve_data$mergedate)
  mo <- strftime(x, "%m")
  yr <- strftime(x, "%Y")
  dd <- data.frame(mo, yr, amt = 1)
  agg <- aggregate(amt ~ mo + yr, dd, FUN = sum)
  agg$date = paste(agg$yr, agg$mo, "01",  sep = "-")
  agg$month = paste(agg$yr, agg$mo,  sep = "-")
  diff = c()
  entrynum = length(agg$date)
  for (i in 1:entrynum-1) {
    date1 = as.Date(agg$date[i], format="%Y-%m-%d")
    date2 = as.Date(agg$date[i+1], format="%Y-%m-%d")
    diff = c(diff, date2-date1)
  }
  agg$daydiff = c(diff, Sys.Date() - as.Date(agg$date[entrynum], format="%Y-%m-%d"))
  agg$throughput <- agg$amt / agg$daydiff
  date <- as.Date(agg$date, "%Y-%m-%d")
  plot(agg$throughput~date, xaxt='n', type='l', ylab = "throughput (#advisories/day)", xlab = "")
  axis(1, date, format(date, "%Y-%m"), cex.axis = .7)
}

coverage <- function(csv, nvd_fee) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  nvddata = read.table(nvd_fee, header = FALSE,  sep = ",")
  cve_data <- mydata[ which(grepl('CVE', mydata$file)), ]
  labelled_nvddata = data.frame(yr = nvddata$V1, total = nvddata$V2)
  x <- as.POSIXct(cve_data$pubdate)
  yr <- strftime(x, "%Y")
  dd <- data.frame(yr, amt = 1)
  agg <- aggregate(amt ~ yr, dd, FUN = sum)
  joined = merge(x=agg,y=labelled_nvddata,by="yr")
  joined$coverage = joined$amt/joined$total
  xx <- barplot(joined$coverage, 
                col = terrain.colors(6), 
                xlab="NVD Feed Year", 
                ylab="Coverage (%)", 
                ylim = c(0,max(joined$coverage)*1.1),
                args.legend = list(bty = 'n', x = 'top', ncol = 1))
  axis(1, at=xx, labels=joined$yr, tick=FALSE, las=2, line=-0.5)
}

mttm_month <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  cve_data <- mydata[ which(grepl('CVE', mydata$file)), ]
  x <- as.POSIXct(cve_data$mergedate)
  mo <- strftime(x, "%m")
  yr <- strftime(x, "%Y")
  dd <- data.frame(mo, yr, delta = cve_data$delta, amt = 1)
  agg <- aggregate(delta ~ mo + yr, dd, FUN = mean)

  agg$date = paste(agg$yr, agg$mo, "01",  sep = "-")
  agg$month = paste(agg$yr, agg$mo,  sep = "-")
  agg = agg[-1,]
  xx <- barplot(agg$delta, 
                col = terrain.colors(6), 
                xlab="", 
                ylab="MTTM", 
                ylim = c(0,max(agg$delta)*1.5),
                args.legend = list(bty = 'n', x = 'top', ncol = 1))
  text(x = xx, y = agg$delta, label = round(agg$delta), pos = 3, cex = 0.8, col = "red")
  axis(1, at=xx, labels=agg$month, tick=FALSE, las=2, line=-0.5)
}

medianttm_month <- function(csv) {
  mydata = read.table(csv, header = TRUE,  sep = ",")
  cve_data <- mydata[ which(grepl('CVE', mydata$file)), ]
  x <- as.POSIXct(cve_data$mergedate)
  mo <- strftime(x, "%m")
  yr <- strftime(x, "%Y")
  dd <- data.frame(mo, yr, delta = cve_data$delta, amt = 1)
  agg <- aggregate(delta ~ mo + yr, dd, FUN = median)
  
  agg$date = paste(agg$yr, agg$mo, "01",  sep = "-")
  agg$month = paste(agg$yr, agg$mo,  sep = "-")
  agg = agg[-1,]
  xx <- barplot(agg$delta, 
                col = terrain.colors(6), 
                xlab="", 
                ylab="Median TTM", 
                ylim = c(0,max(agg$delta)*1.5),
                args.legend = list(bty = 'n', x = 'top', ncol = 1))
  text(x = xx, y = agg$delta, label = round(agg$delta), pos = 3, cex = 0.8, col = "red")
  axis(1, at=xx, labels=agg$month, tick=FALSE, las=2, line=-0.5)
}


#medianttm_month('../data/mttm.csv')
#throughput('../data/mttm.csv')
#coverage('../data/mttm.csv', '../data/nvd.csv')
#package_type_distro('../data/mttm.csv')
#cve_distro('../data/mttm.csv')
#merged_advisories('../data/mttm.csv')
#print(mean_time_to_merge('../data/mttm.csv'))
#print(median_time_to_merge('../data/mttm.csv'))
