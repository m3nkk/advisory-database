#!/bin/bash

default_branch="origin/master"
gitlab_ci_config=".gitlab-ci.yml"
modified_advisories=$(git diff --name-only HEAD $(git merge-base HEAD $default_branch) | grep -v $gitlab_ci_config | grep .yml)
faulty_advisories=0

for advisory in $modified_advisories; do
	if grep -e '^uuid:' $advisory >/dev/null 2>&1; then
		echo "$advisory has been published (uuid found)"
	else
		echo "$advisory has not been published (no uuid)"
		faulty_advisories=$((faulty_advisories+1))
	fi
done

if test $faulty_advisories -ne 0; then
	if test $faulty_advisories -eq 1; then
		echo "1 advisory has not been published"
	else
		echo "$faulty_advisories advisories have not been published"
	fi
	exit 1
fi
